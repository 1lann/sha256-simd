/*
 * Minio Cloud Storage, (C) 2016 Minio, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Copyright 2009 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file of
// Golang project:
//    https://github.com/golang/go/blob/master/LICENSE

// Using this part of Minio codebase under the license
// Apache License Version 2.0 with modifications

// SHA256 hash algorithm.  See FIPS 180-2.

package sha256

import (
	"fmt"
	"testing"
	"encoding/hex"
)

type sha256Test struct {
	out [32]byte
	in  string
}

var golden = []sha256Test{
	{[32]byte{227, 176,
		196, 66,
		152, 252,
		28, 20,
		154, 251,
		244, 200,
		153, 111,
		185, 36,
		39, 174,
		65, 228,
		100, 155,
		147, 76,
		164, 149,
		153, 27,
		120, 82,
		184, 85},
		""},
	{[32]byte{202, 151,
		129, 18,
		202, 27,
		189, 202,
		250, 194,
		49, 179,
		154, 35,
		220, 77,
		167, 134,
		239, 248,
		20, 124,
		78, 114,
		185, 128,
		119, 133,
		175, 238,
		72, 187},
		"a"},
	{[32]byte{251, 142,
		32, 252,
		46, 76,
		63, 36,
		140, 96,
		195, 155,
		214, 82,
		243, 193,
		52, 114,
		152, 187,
		151, 123,
		139, 77,
		89, 3,
		184, 80,
		85, 98,
		6, 3},
		"ab"},
	{[32]byte{186, 120,
		22, 191,
		143, 1,
		207, 234,
		65, 65,
		64, 222,
		93, 174,
		34, 35,
		176, 3,
		97, 163,
		150, 23,
		122, 156,
		180, 16,
		255, 97,
		242, 0,
		21, 173},
		"abc"},
	{[32]byte{186, 120,
		22, 191,
		143, 1,
		207, 234,
		65, 65,
		64, 222,
		93, 174,
		34, 35,
		176, 3,
		97, 163,
		150, 23,
		122, 156,
		180, 16,
		255, 97,
		242, 0,
		21, 173},
		"abc"},
	{[32]byte{136, 212,
		38, 111,
		212, 230,
		51, 141,
		19, 184,
		69, 252,
		242, 137,
		87, 157,
		32, 156,
		137, 120,
		35, 185,
		33, 125,
		163, 225,
		97, 147,
		111, 3,
		21, 137},
		"abcd"},
	{[32]byte{54, 187,
		229, 14,
		217, 104,
		65, 209,
		4, 67,
		188, 182,
		112, 214,
		85, 79,
		10, 52,
		183, 97,
		190, 103,
		236, 156,
		74, 138,
		210, 192,
		196, 76,
		164, 44},
		"abcde"},
	{[32]byte{190, 245,
		126, 199,
		245, 58,
		109, 64,
		190, 182,
		64, 167,
		128, 166,
		57, 200,
		59, 194,
		154, 200,
		169, 129,
		111, 31,
		198, 197,
		198, 220,
		217, 60,
		71, 33},
		"abcdef"},
	{[32]byte{125, 26,
		84, 18,
		123, 34,
		37, 2,
		245, 183,
		155, 95,
		176, 128,
		48, 97,
		21, 42,
		68, 249,
		43, 55,
		226, 60,
		101, 39,
		186, 246,
		101, 212,
		218, 154},
		"abcdefg"},
	{[32]byte{156, 86,
		204, 81,
		179, 116,
		195, 186,
		24, 146,
		16, 213,
		182, 212,
		191, 87,
		121, 13,
		53, 28,
		150, 196,
		124, 2,
		25, 14,
		207, 30,
		67, 6,
		53, 171},
		"abcdefgh"},
	{[32]byte{25, 204,
		2, 242,
		109, 244,
		60, 197,
		113, 188,
		158, 215,
		176, 196,
		210, 146,
		36, 163,
		236, 34,
		149, 41,
		34, 23,
		37, 239,
		118, 208,
		33, 200,
		50, 111},
		"abcdefghi"},
	{[32]byte{114, 57,
		147, 97,
		218, 106,
		119, 84,
		254, 201,
		134, 220,
		165, 183,
		203, 175,
		28, 129,
		10, 40,
		222, 212,
		171, 175,
		86, 178,
		16, 109,
		6, 203,
		120, 176},
		"abcdefghij"},
	{[32]byte{161, 68,
		6, 28,
		39, 31,
		21, 45,
		164, 209,
		81, 3,
		69, 8,
		254, 209,
		193, 56,
		184, 201,
		118, 51,
		157, 226,
		41, 195,
		187, 109,
		75, 187,
		79, 206},
		"Discard medicine more than two years old."},
	{[32]byte{109, 174,
		92, 170,
		113, 58,
		16, 173,
		4, 180,
		96, 40,
		191, 109,
		173, 104,
		131, 124,
		88, 22,
		22, 161,
		88, 154,
		38, 90,
		17, 40,
		141, 75,
		181, 196},
		"He who has a shady past knows that nice guys finish last."},
	{[32]byte{174, 122,
		112, 42,
		149, 9,
		3, 157,
		219, 242,
		159, 7,
		101, 231,
		13, 0,
		1, 23,
		121, 20,
		184, 100,
		89, 40,
		77, 171,
		139, 52,
		140, 45,
		206, 63},
		"I wouldn't marry him with a ten foot pole."},
	{[32]byte{103, 72,
		69, 11,
		1, 197,
		104, 88,
		103, 21,
		41, 29,
		250, 62,
		224, 24,
		218, 7,
		211, 107,
		183, 234,
		111, 24,
		12, 26,
		246, 39,
		2, 21,
		198, 79},
		"Free! Free!/A trip/to Mars/for 900/empty jars/Burma Shave"},
	{[32]byte{20, 184,
		32, 20,
		173, 43,
		17, 246,
		97, 181,
		174, 106,
		153, 183,
		81, 5,
		194, 255,
		172, 39,
		140, 208,
		113, 205,
		108, 5,
		131, 39,
		147, 99,
		87, 116},
		"The days of the digital watch are numbered.  -Tom Stoppard"},
	{[32]byte{113, 2,
		207, 215,
		110, 46,
		50, 72,
		137, 238,
		206, 93,
		108, 65,
		146, 27,
		30, 20,
		42, 74,
		197, 162,
		105, 43,
		231, 136,
		3, 9,
		127, 106,
		72, 216},
		"Nepal premier won't resign."},
	{[32]byte{35, 177,
		1, 140,
		216, 29,
		177, 214,
		121, 131,
		197, 247,
		65, 124,
		68, 218,
		157, 235,
		88, 36,
		89, 227,
		120, 215,
		160, 104,
		85, 46,
		166, 73,
		220, 159},
		"For every action there is an equal and opposite government program."},
	{[32]byte{128, 1,
		241, 144,
		223, 181,
		39, 38,
		28, 76,
		252, 171,
		112, 201,
		142, 128,
		151, 167,
		161, 146,
		33, 41,
		188, 64,
		150, 149,
		14, 87,
		199, 153,
		154, 90},
		"His money is twice tainted: 'taint yours and 'taint mine."},
	{[32]byte{140, 135,
		222, 182,
		85, 5,
		195, 153,
		62, 178,
		75, 122,
		21, 12,
		65, 85,
		232, 46,
		238, 105,
		96, 207,
		12, 58,
		129, 20,
		255, 115,
		109, 105,
		202, 213},
		"There is no reason for any individual to have a computer in their home. -Ken Olsen, 1977"},
	{[32]byte{191, 176,
		166, 122,
		25, 205,
		236, 54,
		70, 73,
		139, 46,
		15, 117,
		27, 221,
		196, 27,
		186, 75,
		127, 48,
		8, 27,
		11, 147,
		42, 173,
		33, 77,
		22, 215},
		"It's a tiny change to the code and not completely disgusting. - Bob Manchek"},
	{[32]byte{127, 154,
		11, 155,
		245, 99,
		50, 225,
		159, 90,
		14, 193,
		173, 156,
		20, 37,
		161, 83,
		218, 28,
		98, 72,
		104, 253,
		164, 69,
		97, 214,
		183, 77,
		175, 54},
		"size:  a.out:  bad magic"},
	{[32]byte{177, 63,
		129, 184,
		170, 217,
		227, 102,
		104, 121,
		175, 25,
		136, 97,
		64, 144,
		79, 127,
		66, 158,
		240, 131,
		40, 97,
		149, 152,
		42, 117,
		136, 133,
		140, 252},
		"The major problem is with sendmail.  -Mark Horton"},
	{[32]byte{178, 108,
		56, 214,
		21, 25,
		232, 148,
		72, 12,
		112, 200,
		55, 78,
		163, 90,
		160, 173,
		5, 178,
		174, 61,
		102, 116,
		238, 197,
		245, 42,
		105, 48,
		94, 212},
		"Give me a rock, paper and scissors and I will move the world.  CCFestoon"},
	{[32]byte{4, 157,
		94, 38,
		212, 241,
		2, 34,
		205, 132,
		26, 17,
		158, 56,
		189, 141,
		46, 13,
		17, 41,
		114, 134,
		136, 68,
		149, 117,
		212, 255,
		66, 184,
		66, 193},
		"If the enemy is within range, then so are you."},
	{[32]byte{14, 17,
		104, 56,
		227, 204,
		28, 26,
		20, 205,
		4, 83,
		151, 226,
		155, 77,
		8, 122,
		161, 27,
		8, 83,
		252, 105,
		236, 130,
		233, 3,
		48, 214,
		9, 73},
		"It's well we cannot hear the screams/That we create in others' dreams."},
	{[32]byte{79, 125,
		142, 181,
		188, 241,
		29, 226,
		165, 107,
		151, 16,
		33, 164,
		68, 170,
		78, 175,
		214, 236,
		208, 243,
		7, 181,
		16, 158,
		78, 119,
		108, 208,
		254, 70},
		"You remind me of a TV show, but that's all right: I watch it anyway."},
	{[32]byte{97, 192,
		204, 76,
		75, 216,
		64, 109,
		81, 32,
		179, 251,
		78, 188,
		49, 206,
		135, 102,
		124, 22,
		47, 41,
		70, 139,
		60, 119,
		150, 117,
		168, 90,
		235, 206},
		"C is as portable as Stonehedge!!"},
	{[32]byte{31, 178,
		235, 54,
		136, 9,
		60, 74,
		63, 128,
		205, 135,
		165, 84,
		126, 44,
		233, 64,
		164, 249,
		35, 36,
		58, 121,
		162, 161,
		226, 66,
		34, 6,
		147, 172},
		"Even if I could be Shakespeare, I think I should still choose to be Faraday. - A. Huxley"},
	{[32]byte{57, 85,
		133, 206,
		48, 97,
		123, 98,
		200, 11,
		147, 232,
		32, 140,
		232, 102,
		212, 237,
		200, 17,
		161, 119,
		253, 180,
		184, 45,
		57, 17,
		216, 105,
		100, 35},
		"The fugacity of a constituent in a mixture of gases at a given temperature is proportional to its mole fraction.  Lewis-Randall Rule"},
	{[32]byte{79, 155,
		24, 154,
		19, 208,
		48, 131,
		130, 105,
		220, 232,
		70, 177,
		106, 28,
		233, 206,
		129, 254,
		99, 230,
		93, 226,
		246, 54,
		134, 51,
		54, 169,
		143, 230},
		"How can you write a big system without C++?  -Paul Glick"},
}

func TestGolden(t *testing.T) {
	for _, g := range golden {
		s := fmt.Sprintf("%x", Sum256([]byte(g.in)))
		if Sum256([]byte(g.in)) != g.out {
			t.Fatalf("Sum256 function: sha256(%s) = %s want %s", g.in, s, hex.EncodeToString(g.out[:]))
		}
	}
}

func TestSize(t *testing.T) {
	c := New()
	if got := c.Size(); got != Size {
		t.Errorf("Size = %d; want %d", got, Size)
	}
}

func TestBlockSize(t *testing.T) {
	c := New()
	if got := c.BlockSize(); got != BlockSize {
		t.Errorf("BlockSize = %d want %d", got, BlockSize)
	}
}

var bench = New()
var buf = make([]byte, 1024*1024)

func benchmarkSize(b *testing.B, size int) {
	b.SetBytes(int64(size))
	sum := make([]byte, bench.Size())
	for i := 0; i < b.N; i++ {
		bench.Reset()
		bench.Write(buf[:size])
		bench.Sum(sum[:0])
	}
}

func BenchmarkHash8Bytes(b *testing.B) {
	benchmarkSize(b, 8)
}

func BenchmarkHash1K(b *testing.B) {
	benchmarkSize(b, 1024)
}

func BenchmarkHash8K(b *testing.B) {
	benchmarkSize(b, 8192)
}

func BenchmarkHash1M(b *testing.B) {
	benchmarkSize(b, 1024*1024)
}
